{
  "variables": {
    "version": "0.90",
    "http_proxy": "{{env `http_proxy`}}",
    "https_proxy": "{{env `https_proxy`}}",
    "ftp_proxy": "{{env `ftp_proxy`}}",
    "no_proxy": "{{env `no_proxy`}}",
    "org": "tompscanlan",
    "role": "packerd",
    "docker_repo_username": "{{env `docker_repo_username`}}",
    "docker_repo_password": "{{env `docker_repo_password`}}",
    "docker_repo_server": "{{env `docker_repo_server`}}",
    "docker_repo_email": "{{env `docker_repo_email`}}",
    "chef_log_level": "{{env `chef_log_level`}}"
  },
  "builders": [
    {
      "name": "ubuntu-docker",
      "type": "docker",
      "image": "ubuntu:trusty",
      "commit": true
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": ["apt-get update; apt-get install -y curl"]
    },
    {
      "type": "chef-solo",
      "cookbook_paths": [
        "provision/chef/vendor-cookbooks"
      ],
      "data_bags_path": "provision/chef/data_bags",
      "roles_path": "provision/chef/roles",
      "json": {
        "http_proxy": "{{user `http_proxy`}}",
        "https_proxy": "{{user `https_proxy`}}",
        "ftp_proxy": "{{user `ftp_proxy`}}",
        "no_proxy": "{{user `no_proxy`}}"
      },
      "run_list": [
        "role[{{user `role`}}]"
      ]
    },
    {
      "type": "shell",
      "inline": [". /etc/profile.d/golang.sh; cd /opt/go/src/github.com/tompscanlan/packerd; go install ./cmd/packerd-server; openssl req -new -newkey rsa:4096 -days 365 -nodes -x509  -subj \"/C=US/ST=KY/L=Louisville/O=none/CN=none.com\" -keyout /etc/ssl/private/temp.key  -out /etc/ssl/private/temp.crt"]
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-tag",
        "repository": "{{user `org`}}/ubuntu-{{user `role`}}",
        "tag": "latest",
        "force": true
      }
    ]
  ]
}
